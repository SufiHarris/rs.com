#!/bin/bash
# WordPress Malware Detection Script
# Run this in your extracted backup directory

echo "=== WordPress Malware Scanner ==="
echo "Scanning directory: $(pwd)"
echo ""

# 1. Find files modified recently (last 30 days)
echo "[1] Recently Modified Files (Suspicious):"
find . -type f -mtime -30 -ls | grep -E "\.(php|js|html)$"
echo ""

# 2. Find suspicious PHP functions
echo "[2] Suspicious PHP Functions Found:"
grep -r -i -n --include="*.php" "eval(" . 2>/dev/null | head -20
grep -r -i -n --include="*.php" "base64_decode" . 2>/dev/null | head -20
grep -r -i -n --include="*.php" "gzinflate" . 2>/dev/null | head -20
grep -r -i -n --include="*.php" "system(" . 2>/dev/null | head -20
grep -r -i -n --include="*.php" "exec(" . 2>/dev/null | head -20
grep -r -i -n --include="*.php" "shell_exec" . 2>/dev/null | head -20
grep -r -i -n --include="*.php" "assert(" . 2>/dev/null | head -20
grep -r -i -n --include="*.php" "str_rot13" . 2>/dev/null | head -20
grep -r -i -n --include="*.php" "passthru" . 2>/dev/null | head -20
echo ""

# 3. Find hidden/suspicious files
echo "[3] Hidden and Suspicious Files:"
find . -type f -name ".*" -o -name "*~*" -o -name "*.suspected"
find . -type f -name "*.php.*" # Files like index.php.bak
find . -type f -name "wp-*.php" | grep -v "wp-content/themes\|wp-content/plugins"
echo ""

# 4. Find suspicious file names
echo "[4] Common Malware Filenames:"
find . -type f -iname "*shell*" -o -iname "*backdoor*" -o -iname "*c99*" -o -iname "*r57*" -o -iname "*sym*" -o -iname "*bypass*"
echo ""

# 5. Check wp-config.php for injections
echo "[5] Checking wp-config.php:"
if [ -f "wp-config.php" ]; then
    echo "Found wp-config.php - Check for suspicious code:"
    grep -n "eval\|base64\|gzinflate" wp-config.php
else
    echo "wp-config.php not found in current directory"
fi
echo ""

# 6. Find PHP files in upload directory (HIGHLY SUSPICIOUS)
echo "[6] PHP Files in Uploads Directory (REMOVE THESE!):"
find ./wp-content/uploads -type f -name "*.php"
echo ""

# 7. Check .htaccess for injections
echo "[7] Checking .htaccess files:"
find . -name ".htaccess" -exec echo "File: {}" \; -exec cat {} \;
echo ""

# 8. Find encoded/obfuscated code
echo "[8] Obfuscated Code Patterns:"
grep -r -i -n --include="*.php" "chr(.*)\." . 2>/dev/null | head -10
grep -r -i -n --include="*.php" "\$[A-Z_]*{" . 2>/dev/null | head -10
echo ""

echo "=== Scan Complete ==="